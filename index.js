let metro = {
    "blueLineBranch": [
        "Yamuna Bank",
        "Laxmi Nagar",
        "Nirman Vihar",
        "Preet Vihar",
        "Karkarduma",
        "Anand Vihar",
        "Kaushambi",
        "Vaishali"
    ],
    "blueLineBranchInterchange": [
        "Yamuna Bank",      // Interchange between Blue Line's Main and Branch Lines
        "Karkarduma",       // Interchange with Pink Line
        "Anand Vihar"       // Interchange with Pink Line
    ],
    "magentaLine": [
        "Botanical Garden",
        "Okhla Bird Sanctuary",
        "Kalindi Kunj",
        "Jasola Vihar Shaheen Bagh",
        "Okhla Vihar",
        "Jamia Millia Islamia",
        "Sukhdev Vihar",
        "Okhla NSIC",
        "Kalkaji Mandir",
        "Nehru Enclave",
        "Greater Kailash",
        "Chirag Delhi",
        "Panchsheel Park",
        "Hauz Khas",
        "IIT Delhi",
        "R.K. Puram",
        "Munirka",
        "Vasant Vihar",
        "Shankar Vihar",
        "Terminal 1 IGI Airport",
        "Sadar Bazar Cantonment",
        "Palam",
        "Dashrathpuri",
        "Dabri Mor - Janakpuri South",
        "Janakpuri West"
    ],
    "magentaLineInterchange": [
        "Botanical Garden",
        "Kalkaji Mandir",
        "Hauz Khas",
        "Janakpuri West"
    ],
    "redLine": [
        "Shaheed Sthal (New Bus Adda)",
        "Hindon River",
        "Arthala",
        "Mohan Nagar",
        "Shyam Park",
        "Major Mohit Sharma Rajendra Nagar",
        "Raj Bagh",
        "Shaheed Nagar",
        "Dilshad Garden",
        "Jhilmil",
        "Mansarovar Park",
        "Shahdara",
        "Welcome",
        "Seelampur",
        "Shastri Park",
        "Kashmere Gate",
        "Tis Hazari",
        "Pul Bangash",
        "Pratap Nagar",
        "Shastri Nagar",
        "InderLok",
        "Kanhaiya Nagar",
        "Keshav Puram",
        "Netaji Subhash Place",
        "Kohat Enclave",
        "Pitam Pura",
        "Rohini East",
        "Rohini West",
        "Rithala"
    ],
    "redLineInterchange": [
        "Welcome",              // Interchange with Pink Line
        "Kashmere Gate",        // Interchange with Yellow and Violet Lines
        "InderLok",             // Interchange with Green Line
        "Netaji Subhash Place"  // Interchange with Pink Line
    ],
    "blueLineMain": [
        "Dwarka Sector 21",
        "Dwarka Sector 8",
        "Dwarka Sector 9",
        "Dwarka Sector 10",
        "Dwarka Sector 11",
        "Dwarka Sector 12",
        "Dwarka Sector 13",
        "Dwarka Sector 14",
        "Dwarka",
        "Dwarka Mor",
        "Nawada",
        "Uttam Nagar West",
        "Uttam Nagar East",
        "Janakpuri West",
        "Janakpuri East",
        "Tilak Nagar",
        "Subhash Nagar",
        "Tagore Garden",
        "Rajouri Garden",
        "Ramesh Nagar",
        "Moti Nagar",
        "Kirti Nagar",
        "Shadipur",
        "Patel Nagar",
        "Rajendra Place",
        "Karol Bagh",
        "Jhandewalan",
        "R K Ashram Marg",
        "Rajiv Chowk",
        "Barakhamba Road",
        "Mandi House",
        "Supreme Court",
        "Indraprastha",
        "Yamuna Bank",
        "Akshardham",
        "Mayur Vihar Phase-1",
        "Mayur Vihar Extension",
        "New Ashok Nagar",
        "Noida Sector 15",
        "Noida Sector 16",
        "Noida Sector 18",
        "Botanical Garden",
        "Golf Course",
        "Noida City Centre",
        "Noida Sector 34",
        "Noida Sector 52",
        "Noida Sector 61",
        "Noida Sector 59",
        "Noida Sector 62",
        "Noida Electronic City"
    ],
    "blueLineMainInterchange": [
        "Janakpuri West",       // Interchange with Magenta Line
        "Rajouri Garden",       // Interchange with Pink Line
        "Kirti Nagar",          // Interchange with Green Line
        "Rajiv Chowk",          // Interchange with Yellow Line
        "Mandi House",          // Interchange with Violet Line
        "Yamuna Bank",          // Interchange between Blue Line's Main and Branch Lines
        "Mayur Vihar Phase-1",        // Interchange with Pink Line
        "Botanical Garden",     // Interchange with Magenta Line
    ],
    "pinkLine": [
        "Majlis Park",
        "Azadpur",
        "Shalimar Bagh",
        "Netaji Subhash Place",
        "Shakurpur",
        "Punjabi Bagh West",
        "ESI Hospital",
        "Rajouri Garden",
        "Mayapuri",
        "Naraina Vihar",
        "Delhi Cantt",
        "Durgabai Deshmukh South Campus",
        "Sir Vishweshwaraiah Moti Bagh",
        "Bhikaji Cama Place",
        "Sarojini Nagar",
        "INA",
        "South Extension",
        "Lajpat Nagar",
        "Vinobapuri",
        "Ashram",
        "Hazrat Nizamuddin",
        "Mayur Vihar Phase-1",
        "Mayur Vihar Pocket-1",
        "Trilokpuri Sanjay Lake",
        "Vinod Nagar East",
        "Vinod Nagar West",
        "IP Extension",
        "Anand Vihar",
        "Karkarduma",
        "Karkarduma Court",
        "Krishna Nagar",
        "East Azad Nagar",
        "Welcome",
        "Jaffrabad",
        "Maujpur-Babarpur",
        "Gokulpuri",
        "Johri Enclave",
        "Shiv Vihar"
    ],
    "pinkLineInterchange": [
        "Netaji Subhash Place",
        "Rajouri Garden",
        "Mayur Vihar Phase-1",
        "Anand Vihar",
        "Karkarduma",
        "Welcome"
    ],
    "yellowLine": [
        "Samaypur Badli",
        "Rohini Sector 18, 19",
        "Haiderpur Badli Mor",
        "Jahangirpuri",
        "Adarsh Nagar",
        "Azadpur",
        "Model Town",
        "GTB Nagar",
        "Vishwa Vidyalaya",
        "Vidhan Sabha",
        "Civil Lines",
        "Kashmere Gate",
        "Chandni Chowk",
        "Chawri Bazar",
        "New Delhi",
        "Rajiv Chowk",
        "Patel Chowk",
        "Central Secretariat",
        "Udyog Bhawan",
        "Lok Kalyan Marg",
        "Jor Bagh",
        "INA", // corrected
        "AIIMS",
        "Green Park",
        "Hauz Khas",
        "Malviya Nagar",
        "Saket",
        "Qutub Minar",
        "Chhatarpur",
        "Sultanpur",
        "Ghitorni",
        "Arjan Garh",
        "Guru Dronacharya",
        "Sikandarpur",
        "MG Road",
        "IFFCO Chowk",
        "HUDA City Centre"
    ],
    "yellowLineInterchange": [
        "Azadpur",
        "Kashmere Gate",
        "Rajiv Chowk",
        "Central Secretariat",
        "INA", // corrected
        "Hauz Khas"
    ],
    "greenLine": [
        "InderLok",
        "Ashok Park Main",
        "Punjabi Bagh",
        "Punjabi Bagh West",
        "Shivaji Park",
        "Madipur",
        "Paschim Vihar East",
        "Paschim Vihar West",
        "Peeragarhi",
        "Udyog Nagar",
        "Maharaja Surajmal Stadium",
        "Nangloi",
        "Nangloi Railway Station",
        "Rajdhani Park",
        "Mundka",
        "Mundka Industrial Area",
        "Ghevra",
        "Tikri Kalan",
        "Tikri Border",
        "Pandit Shree Ram Sharma",
        "Bahadurgarh City",
        "Brigadier Hoshiyar Singh"
    ],
    "greenLineInterchange": [
        "InderLok",
        "Punjabi Bagh West",
        "Kirti Nagar"
    ],
    "violetLine": [
        "Kashmere Gate",
        "Lal Qila",
        "Jama Masjid",
        "Delhi Gate",
        "ITO",
        "Mandi House",
        "Janpath",
        "Central Secretariat",
        "Khan Market",
        "Jawaharlal Nehru Stadium",
        "Jangpura",
        "Lajpat Nagar",
        "Moolchand",
        "Kailash Colony",
        "Nehru Place",
        "Kalkaji Mandir",
        "Govind Puri",
        "Harkesh Nagar Okhla",
        "Jasola Apollo",
        "Sarita Vihar",
        "Mohan Estate",
        "Tughlakabad",
        "Badarpur Border",
        "Sarai",
        "NHPC Chowk",
        "Mewla Maharajpur",
        "Sector 28",
        "Badkhal Mor",
        "Old Faridabad",
        "Neelam Chowk Ajronda",
        "Bata Chowk",
        "Escorts Mujesar",
        "Sant Surdas (Sihi)",
        "Raja Nahar Singh"
    ],
    "violetLineInterchange": [
        "Kashmere Gate",
        "Mandi House",
        "Central Secretariat",
        "Kalkaji Mandir",
        "Lajpat Nagar"
    ],
};

function getStationLines(station) {
    let metroKeys = Object.keys(metro);
    let lines = []
    let n = metroKeys.length;
    for (let i = 0; i < n; i++) {
        if (metroKeys[i].endsWith("Interchange")) {
            continue;
        }
        let stations = metro[`${metroKeys[i]}`];
        let n1 = stations.length;
        for (let j = 0; j < n1; j++) {
            if (stations[j].toLowerCase() === station.toLowerCase()) {
                lines.push(metroKeys[i]);
            }
        }
    }
    return lines;
}

function getStationIndex(station, line) {
    let stations = metro[`${line}`];
    let n = stations.length;
    for (let i = 0; i < n; i++) {
        if (stations[i].toLowerCase() === station.toLowerCase()) {
            return i;
        }
    }
}

function getInterchangeStations(line) {
    return metro[`${line}Interchange`];
}

function sortLines(line) {
    let sortedLines = [];

    while (line.length > 0) {
        let small = line[0];
        let smallIndex = 0;

        for (let j = 1; j < line.length; j++) {
            if (getInterchangeStations(line[j]).length < getInterchangeStations(small).length) {
                small = line[j];
                smallIndex = j;
            }
        }

        sortedLines.push(small);
        line.splice(smallIndex, 1); 
    }

    return sortedLines;
}

function reverseRoute(route) {
let segments = [];
let current = [];

for (let i = 0; i < route.length; i++) {
    let station = route[i];
    
    if (station === "Interchange") {
        if (current.length > 0) {
            segments.push(current);
        }
        segments.push(["Interchange"]);
        current = [];
    } else {
        current.push(station);
    }
}

if (current.length > 0) {
    segments.push(current);
}

    let reversed = [];
    for (let i = segments.length - 1; i >= 0; i--) {
        if (segments[i][0] === "Interchange") {
            reversed.push("Interchange");
        } else {
            reversed.push(...segments[i].reverse());
        }
    }

    return reversed;
}


function getFinalRoute(startStation, endStation, comingFrom = "", visited = [], interchange=0 ){
    if(getStationLines(startStation).length<=getStationLines(endStation).length) {
        return getRoute(startStation, endStation, comingFrom, visited, interchange);
    }
    return reverseRoute(getRoute(endStation, startStation, comingFrom, visited, interchange));
}

function shortestPath(startStation, endStation, ways) {
    if (ways.length === 0) return [];

    let shortestWay = ways[0];
    let shortestWayIndex = 0;
    for (let i = 1; i < ways.length; i++) {
        if (ways[i].length < shortestWay.length) {
            shortestWay = ways[i];
            shortestWayIndex = i;
        }
    }
    if(shortestWay[0].toLowerCase()==startStation.toLowerCase()&&shortestWay[shortestWay.length-1].toLowerCase()==endStation.toLowerCase()) {
    return shortestWay;
    }
    else{
        ways.splice(shortestWayIndex, 1);
        return shortestPath(startStation, endStation, ways);
    }
}


function getRoute(startStation, endStation, comingFrom = "", visited = [], interchange = 0) {
    let ways = [];

    let startStationLines = getStationLines(startStation);
    let endStationLines = getStationLines(endStation);

    startStationLines = sortLines(startStationLines);
    endStationLines = sortLines(endStationLines);

    for (let i = 0; i < startStationLines.length; i++) {
        const line = startStationLines[i];

        if (endStationLines.includes(line)) {
            let startIndex = getStationIndex(startStation, line);
            let endIndex = getStationIndex(endStation, line);
            let slice = startIndex < endIndex
                ? metro[line].slice(startIndex, endIndex + 1)
                : metro[line].slice(endIndex, startIndex + 1).reverse();
            return slice;
        } 

        else if (line.toLowerCase() === comingFrom.toLowerCase()) {
            continue;
        } 

        else {
            let interchanges = getInterchangeStations(line);
            interchange++;

            if (interchange > 5) {
                return [];
            }

            for (let j = 0; j < interchanges.length; j++) {
                const inter = interchanges[j];

                if (inter.toLowerCase() === startStation.toLowerCase() || visited.includes(inter)) {
                    continue;
                }

                let nextRoute = getFinalRoute(inter, endStation, line, [...visited, startStation], interchange);

                if (nextRoute && nextRoute.length > 0) {
                    let startIndex = getStationIndex(startStation, line);
                    let interchangeIndex = getStationIndex(inter, line);

                    let slice = startIndex < interchangeIndex
                        ? metro[line].slice(startIndex, interchangeIndex + 1)
                        : metro[line].slice(interchangeIndex, startIndex + 1).reverse();

                    ways.push([...slice, "Interchange", ...nextRoute]);
                }
            }
        }
    }
    if (ways.length === 0) return [];
    return shortestPath(startStation, endStation, ways);
}

function isSubset(sub, full) {
    for (let i = 0; i < sub.length; i++) {
        let found = false;
        for (let j = 0; j < full.length; j++) {
            if (sub[i] === full[j]) {
                found = true;
                break;
            }
        }
        if (!found) return false;
    }
    return true;
}

function getDirectionedInterchangeMetroRoute(route) {
    const newRoute = [];
    const metroKeys = [];
    const allKeys = Object.keys(metro);

    for (let i = 0; i < allKeys.length; i++) {
        if (!allKeys[i].endsWith("Interchange")) {
            metroKeys.push(allKeys[i]);
        }
    }
    let firstInterchangeIndex = route.indexOf("Interchange");
    let initialSegment = (firstInterchangeIndex === -1)
        ? route.slice()
        : route.slice(0, firstInterchangeIndex);

    for (let i = 0; i < metroKeys.length; i++) {
        let line = metroKeys[i];
        if (isSubset(initialSegment, metro[line])) {
            let startIndex = getStationIndex(initialSegment[0], line);
            let endIndex = getStationIndex(initialSegment[initialSegment.length - 1], line);
            let direction = (startIndex < endIndex)
                ? metro[line][metro[line].length - 1]
                : metro[line][0];
            newRoute.push(`Start ${line.toUpperCase()} towards ${direction}`);
            break;
        }
    }
    let i = 0;
    while (i < route.length) {
        if (route[i] !== "Interchange") {
            newRoute.push(route[i]);
            i++;
            continue;
        }

        const segmentStartIndex = i + 1;
        let segmentEndIndex = route.length;

        for (let j = segmentStartIndex; j < route.length; j++) {
            if (route[j] === "Interchange") {
                segmentEndIndex = j;
                break;
            }
        }

        const segment = route.slice(segmentStartIndex, segmentEndIndex);

        for (let k = 0; k < metroKeys.length; k++) {
            let line = metroKeys[k];
            if (isSubset(segment, metro[line])) {
                let startIndex = getStationIndex(segment[0], line);
                let endIndex = getStationIndex(segment[segment.length - 1], line);
                let direction = (startIndex < endIndex)
                    ? metro[line][metro[line].length - 1]
                    : metro[line][0];
                newRoute.push(`Interchange ${line.toUpperCase()} towards ${direction}`);
                break;
            }
        }

        i++;
    }

    return newRoute;
}





function directionedRoute(startStation, endStation) {
    let route = getFinalRoute(startStation, endStation);
    if (route.length === 0) return [];
    return getDirectionedInterchangeMetroRoute(route);
}

